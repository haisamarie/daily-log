---
title: 'Next.js Pages Routerのプロジェクトでsitemapを生成する。'
date: '2025-09-19'
thumbnail: '/images/posts/20250920-sitemap/react.jpg'
---

Next.js の Pages Router のプロジェクトで、 [next-sitemap](https://github.com/iamvishnusankar/next-sitemap) というライブラリを用いてサイトマップを生成していました。しかし、Next.js v15 へのアップグレードに伴い、リクエスト API が非同期になったことなどの影響で動作しなくなったため、今回は自作によるサイトマップ生成へ切り替えました。

## 1. プロジェクト全体のアーキテクチャ

以下のような構成を前提としています。

- **CMS でデータ管理：**  
  コンテンツは CMS 管理しており、投稿記事などの情報を取得。

- **SSG（静的サイト生成）：**  
  Next.js の SSG を前提としており、ビルド時に全コンテンツを静的ファイルとして出力。

- **サイトマップも静的ファイルとして出力：**  
  サイトマップはビルド時に生成し、public フォルダ内に sitemap.xml として保存されます。

- **データフェッチ方法：**  
  `getStaticProps`を利用してビルド時に一度だけデータを取得します。  
  ※記事更新時は再ビルドが必要となるため、CI/CD による自動化

---

## 2. sitemap.xml.tsx の作成

まずは、pages ディレクトリ配下に sitemap.xml.tsx というコンポーネントを作成します。  
今回は、以下の理由から通常のページコンポーネントとして処理せずに、直接レスポンスとして XML を出力する構成としています。

- **notFound の活用：**  
  `getStaticProps` の戻り値に `notFound: true` を設定することで、Next.js による自動ページ生成を抑制します。

- **デフォルトエクスポートとして null を返却：**  
  ブラウザ側で何もレンダリングされないようにしています。

```jsx
export const getStaticProps: GetStaticProps = async () => {
  // ここでサイトマップのXMLコードを生成する
  return {
    notFound: true,
  };
};

export default () => null;
```

---

## 3. XML 形式のサイトマップ生成とファイル出力

CMS から取得した投稿記事データを利用し、XML 形式のサイトマップ文字列を生成します。その後、Node.js の標準モジュールである`fs`を使用してファイル出力します。
※generateSitemap 関数に関しては後述します。

```
export const getStaticProps: GetStaticProps = async () => {
  // generateSitemapはデータを渡してXMLを生成する関数、CMSのデータを渡してます
  const sitemap = await generateSitemap(Posts);

  try {
    // XML文字列をpublicフォルダ内にsitemap.xmlとして書き出し
    await fs.promises.writeFile("./public/sitemap.xml", sitemap);
  } catch (err) {
    console.error("サイトマップ生成に失敗しました。", err);
  }

  return {
    notFound: true,
  }
};

export default () => null;
```

### fs モジュールを使ってファイル出力する

`generateSitemap`により、XML 文字列に組み立てられるので、fs モジュールでファイル出力します。下記の処理で、XML 文字列の内容が、指定されたパスに非同期で書き込まれます。

```
await fs.promises.writeFile(`書き出し先`, XML文字列の内容)
```

---

## 4. generateSitemap 関数の実装

generateSitemap 関数は、投稿記事情報を基に URL リストを生成し、最終的に XML 形式のサイトマップ文字列を返す関数です。

### 4.1 URL の生成

まず、コンテンツの URL を生成します。

```jsx
const siteURL = 'https://example.com';
const totalPages = 150;

// CMSから取得した投稿データでそれぞれのURLを生成
const postUrls = posts.map((post) => `${siteURL}/${post.slug}`);
const range = (start: number, end: number): number[] =>
  [...Array(end - start + 1)].map((_, i) => start + i);

const paginationUrls = range(1, totalPages).map((pageNumber) => `${siteURL}/page/${pageNumber}`);

// 全URLを統合
const allUrls = [siteURL, ...paginationUrls, ...postUrls];
```

### 4.2 特殊文字のエスケープして`<url>`形式に変換

XML では、`&`, `<`, `>`, `"` などの特殊文字がそのまま含まれると構文エラーの原因となるため、これらを適切にエスケープした上で`<url>`形式に変換します

```jsx
const escapeHTML = (str: string) =>
  str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

const urlList = allUrls.reduce((acc, url) => acc + `<url><loc>${escapeHTML(url)}</loc></url>`, '');
```

### 4.3 全体を 1 つの XML 文字列として返します。

```
return `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:news="http://www.google.com/schemas/sitemap-news/0.9"
        xmlns:xhtml="http://www.w3.org/1999/xhtml"
        xmlns:image="http://www.google.com/schemas/sitemap-image/1.1"
        xmlns:video="http://www.google.com/schemas/sitemap-video/1.1">
${urlList}
</urlset>`;
```

---

## 5.sitemap.xml が生成できたら Seach Console で送信

サイトマップファイルが正しく生成され public/sitemap.xml に置かれたら、Google Search Console を利用してサイトマップを送信して完了です。
[https://developers.google.com/search/docs/crawling-indexing/sitemaps/build-sitemap?hl=ja#addsitemap](https://developers.google.com/search/docs/crawling-indexing/sitemaps/build-sitemap?hl=ja#addsitemap)

---

## 6.最後に

Next.js の app router では、v13.3.0 から公式に sitemap に関する機能が追加され、サイトマップ生成が簡単にできるようになりました。しかし、Pages router 環境ではこの機能が利用できないため、今回ご紹介した自作によるサイトマップ生成の手法が現状最適なアプローチかなと考えています。
CMS データを活用し、ビルド時に静的ファイルとしてサイトマップを生成する方法は、安定運用が可能なだけでなく、必要に応じたカスタマイズも柔軟に行えるため、まだまだ改善点はありますが、しばらくはこの方法で対応していきたいと思います。

---

## 参考

[https://developers.google.com/search/docs/crawling-indexing/sitemaps/overview?hl=ja](https://developers.google.com/search/docs/crawling-indexing/sitemaps/overview?hl=ja)

[https://zenn.dev/catnose99/articles/c441954a987c24](https://zenn.dev/catnose99/articles/c441954a987c24)

[https://qiita.com/kulikala/items/135da20465c367348b52](https://qiita.com/kulikala/items/135da20465c367348b52)
